<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket 示例</title>
</head>
<body>
<div class="container">
    <h1>WebSocket 示例</h1>

    <div class="input-section">
        <input type="text" id="messageInput" placeholder="输入您的消息..." value="给我讲个笑话">
        <button id="sendBtn">发送</button>
        <button id="stopBtn" disabled>停止</button>
    </div>

    <div id="status" class="status" style="display: none;"></div>

    <div class="response-section">
        <h2>响应内容:</h2>
        <div id="response"></div>
    </div>
</div>

<script src="sockjs.min.js"></script>
<script src="stomp.min.js"></script>

<script>
    let stompClient = null;
    let socket = null;
    let pendingMessage = null; // 保存待发送的消息（连接未建立时）
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const stopBtn = document.getElementById('stopBtn');
    const responseDiv = document.getElementById('response');
    const statusDiv = document.getElementById('status');

    function updateStatus(message) {
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
    }

    function connectWebSocket() {
        // 检查必要的库是否加载
        if (typeof SockJS === 'undefined' || typeof Stomp === 'undefined') {
            console.error('库未加载，请检查 JS 文件');
            updateStatus('错误：库未加载');
            sendBtn.disabled = false;
            stopBtn.disabled = true;
            return;
        }

        // 关闭之前的连接（如果存在）
        if (stompClient && stompClient.connected) {
            stompClient.disconnect();
        }

        // 连接中：禁用发送按钮（避免重复连接），启用停止按钮（可以取消连接）
        sendBtn.disabled = true;
        stopBtn.disabled = false;
        updateStatus('正在连接...');

        // 创建新的 WebSocket 连接
        // 注意：使用 SockJS 时，必须使用 http:// 或 https:// 协议，而不是 ws://
        try {
            socket = new SockJS('http://localhost:8080/ws/chat');
            stompClient = Stomp.over(socket);

            // 禁用 STOMP 的调试日志（可选）
            stompClient.debug = null;
        } catch (error) {
            console.error('创建 WebSocket 连接失败:', error);
            updateStatus('连接失败: ' + error.message);
            sendBtn.disabled = false;
            stopBtn.disabled = true;
            return;
        }

        stompClient.connect({}, function () {
            // 连接成功：启用发送按钮（可以发送消息），启用停止按钮（可以随时断开连接）
            sendBtn.disabled = false;
            stopBtn.disabled = false;
            updateStatus('连接成功');

            // 订阅响应主题
            let isFirstPartial = true; // 标记是否是第一次收到 partial 消息
            stompClient.subscribe('/topic/response', function (message) {
                const data = JSON.parse(message.body);

                if (data.type === 'partial') {
                    // 实时追加增量 token
                    responseDiv.textContent += data.content;

                    // 只在第一次收到 partial 时更新状态，避免频繁更新导致闪烁
                    if (isFirstPartial) {
                        updateStatus('正在接收响应...');
                        isFirstPartial = false;
                    }
                    // 正在接收流式响应：禁用发送按钮（避免中断当前响应），启用停止按钮（可以停止接收）
                    sendBtn.disabled = true;
                    stopBtn.disabled = false;
                } else if (data.type === 'complete') {
                    // 响应完成
                    console.log('完整响应:', data.content);

                    // 重置标记，为下次响应做准备
                    isFirstPartial = true;
                    // 响应完成：启用发送按钮（可以发送新消息），禁用停止按钮（无需停止）
                    sendBtn.disabled = false;
                    stopBtn.disabled = true;
                    updateStatus('响应完成');
                } else if (data.type === 'error') {
                    // 错误处理
                    console.error('WebSocket 错误:', data.content);

                    // 重置标记，为下次响应做准备
                    isFirstPartial = true;
                    // 收到错误响应：启用发送按钮（可以重试），禁用停止按钮（错误已结束）
                    sendBtn.disabled = false;
                    stopBtn.disabled = true;
                    updateStatus('收到错误响应');
                }
            });

            // 订阅完成后，如果有待发送的消息，自动发送
            if (pendingMessage) {
                const message = pendingMessage;
                pendingMessage = null;
                sendMessage(message);
            }
        }, function (error) {
            // STOMP 连接错误回调
            console.error('STOMP 连接错误:', error);

            // STOMP 连接失败：启用发送按钮（可以重试连接），禁用停止按钮（连接未建立）
            sendBtn.disabled = false;
            stopBtn.disabled = true;
            updateStatus('连接失败: ' + (error.headers?.message || error));
        });

        socket.onerror = function (error) {
            console.error('WebSocket 错误:', error);

            // WebSocket 连接错误：启用发送按钮（可以重试），禁用停止按钮（连接已失败）
            sendBtn.disabled = false;
            stopBtn.disabled = true;
            updateStatus('连接错误：请确保服务器正在运行（http://localhost:8080）');
        };

        socket.onclose = function () {
            console.log('连接已关闭');

            // 连接关闭：启用发送按钮（可以重新连接），禁用停止按钮（连接已断开）
            sendBtn.disabled = false;
            stopBtn.disabled = true;
            updateStatus('连接已关闭');
        };
    }

    function sendMessage(message) {
        if (stompClient && stompClient.connected) {
            // 每次发送前清空之前的响应内容
            responseDiv.textContent = '';
            stompClient.send('/app/chat', {}, message);

            // 消息已发送：更新状态为等待响应，禁用发送按钮（等待响应中），启用停止按钮（可以中断请求）
            sendBtn.disabled = true;
            stopBtn.disabled = false;
            updateStatus('等待响应...');
        } else {
            // 如果未连接，保存消息并尝试重新连接
            pendingMessage = message;
            console.warn('WebSocket 未连接，尝试重新连接...');
            connectWebSocket();
        }
    }

    // 发送按钮事件
    sendBtn.addEventListener('click', () => {
        const message = messageInput.value.trim();
        if (!message) {
            alert('请输入消息内容');
            return;
        }

        sendMessage(message);
    });

    // 停止按钮事件
    stopBtn.addEventListener('click', () => {
        if (stompClient && stompClient.connected) {
            stompClient.disconnect();

            // 手动停止连接：启用发送按钮（可以重新连接），禁用停止按钮（连接已断开）
            sendBtn.disabled = false;
            stopBtn.disabled = true;
            updateStatus('连接已停止');
        }
    });

    // 支持回车键发送
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendBtn.click();
        }
    });

    // 页面初始化时建立 WebSocket 连接
    connectWebSocket();
</script>
</body>
</html>