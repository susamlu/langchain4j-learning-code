<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>可取消 SSE 示例</title>
</head>
<body>
<div class="container">
    <h1>可取消 SSE 示例</h1>

    <div class="input-section">
        <input type="text" id="messageInput" placeholder="输入您的消息..." value="给我讲个笑话">
        <button id="sendBtn">发送</button>
        <button id="stopBtn" disabled>停止</button>
    </div>

    <div id="status" class="status" style="display: none;"></div>

    <div class="response-section">
        <h2>响应内容:</h2>
        <div id="response"></div>
    </div>
</div>

<script>
    let eventSource = null;
    let currentRequestId = null;
    let isFirstMessage = true; // 标记是否是第一次收到消息
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const stopBtn = document.getElementById('stopBtn');
    const responseDiv = document.getElementById('response');
    const statusDiv = document.getElementById('status');

    function updateStatus(message) {
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
    }

    // 生成唯一的请求 ID
    function generateRequestId() {
        return 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function connectToSSE(message) {
        // 关闭之前的连接（如果存在）
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }

        // 生成新的请求 ID
        currentRequestId = generateRequestId();

        // 每次发送前清空之前的响应内容
        responseDiv.textContent = '';
        isFirstMessage = true;

        // 连接中：禁用发送按钮（避免重复连接），启用停止按钮（可以取消连接）
        sendBtn.disabled = true;
        stopBtn.disabled = false;
        updateStatus('正在连接...');

        // 创建新的 EventSource 连接
        const url = `http://localhost:8080/api/cancellable/chat/stream?message=${encodeURIComponent(message)}&requestId=${encodeURIComponent(currentRequestId)}`;
        eventSource = new EventSource(url);

        eventSource.addEventListener('message', (event) => {
            // 只在第一次收到消息时更新状态，避免频繁更新导致闪烁
            if (isFirstMessage) {
                updateStatus('正在接收响应...');
                isFirstMessage = false;
            }

            // 实时追加增量 token
            responseDiv.textContent += event.data;

            // 正在接收流式响应：禁用发送按钮（避免中断当前响应），启用停止按钮（可以停止接收）
            sendBtn.disabled = true;
            stopBtn.disabled = false;
        });

        eventSource.addEventListener('complete', (event) => {
            // 响应完成
            console.log('完整响应:', event.data);

            // 关闭连接
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            currentRequestId = null;

            // 响应完成：启用发送按钮（可以发送新消息），禁用停止按钮（无需停止）
            sendBtn.disabled = false;
            stopBtn.disabled = true;
            updateStatus('响应完成');
        });

        eventSource.onerror = (error) => {
            console.error('SSE 错误:', error);

            // 关闭连接
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            currentRequestId = null;

            // 连接错误：启用发送按钮（可以重试），禁用停止按钮（连接已失败）
            sendBtn.disabled = false;
            stopBtn.disabled = true;
            updateStatus('连接错误：请确保服务器正在运行（http://localhost:8080）');
        };
    }

    function cancelRequest() {
        if (currentRequestId) {
            // 调用取消接口
            fetch(`http://localhost:8080/api/cancellable/chat/cancel?requestId=${encodeURIComponent(currentRequestId)}`, {
                method: 'POST'
            }).then(() => {
                console.log('取消请求已发送');
            }).catch(error => {
                console.error('取消请求失败:', error);
            });

            // 关闭 SSE 连接
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            currentRequestId = null;

            // 手动停止连接：启用发送按钮（可以重新连接），禁用停止按钮（连接已断开）
            sendBtn.disabled = false;
            stopBtn.disabled = true;
            updateStatus('连接已停止');
        }
    }

    function sendMessage(message) {
        if (!message) {
            alert('请输入消息内容');
            return;
        }

        connectToSSE(message);
    }

    // 发送按钮事件
    sendBtn.addEventListener('click', () => {
        const message = messageInput.value.trim();
        sendMessage(message);
    });

    // 停止按钮事件
    stopBtn.addEventListener('click', () => {
        cancelRequest();
    });

    // 支持回车键发送
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendBtn.click();
        }
    });
</script>
</body>
</html>

